Google カレンダーの医局内共有設定ツール<br>`calendar_permission`
================
2022-02-07 (updated: 2022-02-15)

## 概要

### はじめに

`calendar_permission`
は、医局の共有カレンダーの共有設定を少しでも楽で確実なものにするために作られた、以下の機能を備えた
Google スプレッドシートです。

-   わかりやすく視認性の高いスプレッドシートによる入力と管理
-   誤まった入力に対する入力制限、各種シートの保護による高い保全性
-   シートの情報をもとにした、カレンダー共有権限一括限更新プログラムの実行
-   各種プログラム実行のためのコンソール UI をスプレッドシート上に提供

### 仕様における注意

本ツールは**素人**が少しでも正確で効率の良いカレンダー共有権限管理ができるように考えて作成したものです。

動作に関する不具合は可能な限りのテストを行うことで除去しておりますが、世に出回るソフトウェアに求められる水準には到底達しておりません。
別の言い方をすると、**誤った使い方により意図しない動作を生じさせる危険性があります。**

このため、以下の「管理マニュアル」および「使い方の詳細」をよくお読みいただき、正しくお使いくださいますようお願いいたします。

### 簡易マニュアル

ここではカレンダー共有のための定義を変更・更新するための最も簡単な手順を箇条書きにします。<br>
勘の良い方なら、これらの記載だけでもすぐにご使用いただけるとは思いますが、詳細は「使い方の詳細」における該当箇所もご確認ください。

1.  スプレッドシートを開く
2.  サイドバーを開く
3.  サイドバーのボタンを押して作業用シートを作成する
4.  作業用シートを編集する
5.  サイドバーのボタンを押してカレンダー共有権限一括更新プログラムを実行する  
6.  メッセージと実行ログを確認する

### 高度な設定が必要な場合

本ツール自体の共有設定を変更したいとき、共有するカレンダーが増えたり減ったり変更になったとき、管理者を交代するとき、といった場合には別途設定が必要です。
「高度な設定」の該当する部分をご確認ください。

-   スプレッドシートの共有設定を変更する
-   共有するカレンダーの定義を変更する
-   管理者を交代する

<div style="page-break-before:always">

</div>

## 使い方の詳細

### スプレッドシートを開く

本スプレッドシートは、
誰もが閲覧・編集できるわけではありません。医局内の Google
アカウントの管理者のみが閲覧・編集できるように (安全に) 設定しています。
ここでは、既にスプレッドシートの共有設定が正しくなされていることを前提に話をすすめます。

管理者の交代などにより共有設定の変更が必要な場合は「高度な設定」の該当箇所の記載に従って設定変更を行ってください。

まず、ブラウザより Google Drive を開きます。

[Google Drive](https://drive.google.com/)

左側にあるメニューから「共有アイテム」を選ぶと、「calendar_permission」の名前のついたスプレッドシートが見つかるはずです。
これをクリックして開いてください。

### サイドバーを開く

さて無事にスプレッドシートを開くことができたら、次は本ツール特製のユーザーインターフェイス
(UI) を開いてみましょう。

<img src="./materials/open_sidebar.png" width="50%">

スプレッドシートを開いて<u>一呼吸置くと</u>、写真のように上部メニューに「サイドバーを開く」という項目が出現します。
このボタンを押し、次に出てくる「開く」ボタンを押すと、**サイドバー**が出現します。

<img src="./materials/sidebar.png" width="70%">

このサイドバーは、プログラム実行のためのコンソール UI となっています。
実際にプログラムを実行するときには、サイドバーの実行ボタンを押すことでプログラムが開始されます。

さらに、サイドバー上部の「参照リンク」からは操作マニュアル(本ページ)や
Google
カレンダーへのリンクが張られています。作業中の各種確認にご活用ください。

<div style="page-break-before:always">

</div>

### 作業用シートを作る

<img src="./materials/sheet_names.png">

写真のように、スプレッドシートに既にいくつかのシートが存在していますが、いずれも「鍵」マークが付いていることにお気付きいただけると思います。
これらのシートは過去に作成した共有変更を定義したものであったり、ツール全体に関わる設定用のシートだったりします。
このため、基本的にはシートの内容が容易に書き替えららないように制限がかかっています。

カレンダー共有権限を今から変更したいときには、まず**編集可能な新しい作業用のシートを作成する**必要があります。
この作業用のシートは、サイドバーのボタンを押すことでいとも簡単に作成することができます。

<div style="page-break-before:always">

</div>

### 作業用シートを編集する

上述のように、シート名が日付時刻のシートは、過去のカレンダー共有設定の定義が記載されています。
最新の日付時刻が名前となっているシートのコピーである**作業用シートには、現在の共有設定の定義が記載されている**ことになります。

現在の共有設定のうち特定のメンバーの権限を削除するときは、該当メンバーの記載された行を**行ごと削除**してください。

該当メンバーが医局員である場合などは、<u>氏名と Gmail アドレスの情報を
`former_members`
シートに残しておくと、再び同じメンバーに権限を付与する際に便利</u>です。

新たなメンバーにカレンダー共有権限を与えるためには、**新たな行にメンバーの氏名、Gmail
アドレス、各カレンダーへの共有制限定義を記載**します。

シートの編集においては、誤記入を極力減らすために、セルへの入力規則が細かく設定してあります。
入力規則に違反した入力が検出されると、以下のようなエラーメッセージが出現します。

<img src="./materials/input_error.png" width="50%">

これにより誤った入力はほぼ回避されることが期待されますが、<u>入力においては他のセルからのコピペを多用するなどして、誤入力軽減に務めてください</u>。

カレンダーへの共有制限定義については、以下の3つの制限種別があります。

-   **reader**: すべての予定の詳細について閲覧だけを行うことができる
-   **writer**: reader
    の持つ権限に加えて、すべての予定の変更を行うことができる
-   **owner**: writer の持つ権限に加えて、共有の変更権限を有する

一概には言えませんが、スタッフにはすべてのカレンダーに対する writer
権限を、医員や大学院生には手術や入院業務に関するカレンダーの reader
権限とそれ以外のカレンダーに対する writer 権限を付与しています。

医局秘書やテクニカルスタッフ、病棟・外来MAに対する権限付与は、各業務を鑑みて最低限の権限付与となるように設定しています。
特に writer
権限は、上記職種の方々にとっては不要な機能である場合が多く、カレンダーの誤操作等のリスクを減らすためにも、<u>職種によらず最低限の権限付与となるよう常に見直しを行っていただくこと</u>をお勧めいたします。

<div style="page-break-before:always">

</div>

### カレンダー共有権限一括更新プログラムを実行する

作業用シートの編集が終わったら、いよいよ権限の一括更新プログラムを実行です。先に述べたように、プログラムの実行はサイドバーの
UI より行います。

<img src="./materials/run_program.png" width= "30%">

写真のように、**サイドバー下部のボタンを押すとプログラムが実行されます。**
このとき、ボタンの上にある<u>チェックボックスに忘れずにチェックを入れてください</u>。

これでプログラムが実行されますが、**実際にきちんと権限が更新されたかはまだわかりません。**
事項の記載に従ってプログラム終了時のメッセージ、実行ログ、さらにはカレンダーにおける共有設定の確認を確実に行ってください。

<div style="page-break-before:always">

</div>

### メッセージと実行ログを確認する

プログラム実行を行うと、何かしらのメッセージが画面上部にポップアップされます。

<img src="./materials/message.png">

プログラムが正しく実行され、シートの情報をもとにカレンダーの共有権限が更新された場合には以下のように、SUCCESS
メッセージが表示されます。
このとき、先ほどまで編集を行っていた**作業用シートの名前は自動的にプログラム終了時の日付・時刻へと変更されます**。

<img src="./materials/success.png" width="50%">

同時に、以下の写真のように `log` シートには実行ログが記録されます。
ご自身の変更がきちんと実行ログに記載されていることを確認してください。

<img src="./materials/log.png" width="70%">

<div style="page-break-before:always">

</div>

チェックボックスへのチェック入力を行っていなかった場合には、プログラムは実行されず以下のようなメッセージが表示されます。
チェックを入れた上で、再度実行ボタンを押してください。

<img src="./materials/fill_checkbox.png" width="50%">

プログラムが実行されたが、何らかの問題が生じて最後まで正しく動作しなかった場合には、以下のような
ERROR メッセージが表示されます。
このとき、作業用シートの名前の変更は起こりません。
**次項「トラブルシューティング」を参照し、適切に対処を行ってください**。

<img src="./materials/error.png" width="50%">

<div style="page-break-before:always">

</div>

### トラブルシューティング

ここでは、プログラム実行後に ERROR
メッセージが表示された場合の対処について述べます。
実際には以下の記載事項だけでは対処できない問題が生じている可能性もありますが、比較的簡単に問題の同定が可能なシチュエーションだけを取り上げることにします。

これらの記載では問題解決に至らない場合には、開発者 (kkirino)
へのご連絡をお願いいたします。

-   <u>**作業用シートの名前を `input` にしていない**</u>

最も可能性が高いのがこの名前のつけ忘れまたはつけ間違いです。

大切なのは、正しく “input” となっているかどうかです。例えば、“input␣”
のように最後にスペースが含まれるだけでも本ツールは正しく動きません。

今一度、作業用シートの名前をご確認ください。

-   <u>**作業用シートの余白部分に何らかの記載をいれてしまった**</u>

何かしらのミスにより、シートの余白部分に記載がなされたために、正常な動作を行うことが出来なくなった可能性が考えられます。記載を消した上で改めて実行を行ってください。

またこのような場合には、はじめは正常に動作したが、途中で止まってしまった、というような挙動を示していることがあります。
`log`
シートの実行ログをご確認いただくと、実行が途中で止まったことがわかるかもしれません。

-   <u>**作業用シートの列名や、変更が制限されているシートを変更してしまった**</u>

作業用シートの列名が変更されるとバグを生む原因になります。
同時に、`calendar_list`
という名前の鍵マークのついたシートの記載が変更された場合にもプログラムに影響が生じます。

これらのシートへの変更が疑われた場合には、「バックアップされたスプレッドシートを開く」を参照のうえ、変更箇所の同定と復元を試みてください。

<div style="page-break-before:always">

</div>

## 高度な作業

### スプレッドシートの共有設定を変更する
